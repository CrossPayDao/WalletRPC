# 研发流程（Stages & Rules）

本文件定义 Wallet RPC 的研发阶段与各阶段准则（含准入/退出条件）。
目的：降低沟通成本，确保“产品目标、文档、代码、测试”持续一致，并始终满足 **RPC-only、后台 0 依赖、零遥测** 的不可变原则。

## 0. 总原则（跨阶段生效）
- **P0 不可变原则**：业务数据请求仅可访问去中心化节点 RPC（详见 `immutable-principle-rpc-only.md`）。
- **文档优先**：需求/规则变更必须先更新文档，再进入实现。
- **可验收**：每项需求必须具备可验证的验收标准。
- **可追踪**：建议为需求分配 ID，并在实现/测试中可追溯（见 `change-process.md`）。
- **提交信息英文（Commit message）**：所有代码提交的 Git commit message 必须使用英文（建议动词开头、简洁明确；避免中英混写）。
- **回归测试强制（阶段化执行）**：凡修复任何 bug（功能/逻辑/性能/体验/兼容性/适配性），必须最终补充至少一条自动化回归测试。
  - 补测动作在 **2.4 验证阶段（Verification）** 集中完成，不在 **2.3 实现阶段（Implementation）** 新增测试代码。
  - 若短期内确实无法自动化覆盖：必须记录“豁免原因 + 风险评估 + 人工验收步骤 + 补测计划与截止时间”，并在后续阶段补齐。

## 1. 阶段划分
建议将一次功能或版本迭代按以下阶段推进：
1. 产品定义阶段（Product Definition）
2. 设计与约束检查阶段（Design & Constraints）
3. 实现阶段（Implementation）
4. 验证阶段（Verification）
5. 产品验收阶段（Product Acceptance）
6. 发布阶段（Release）

说明：阶段不强制严格串行，但进入“产品验收阶段”前必须完成所有前置条件。

## 2. 各阶段准则

### 2.1 产品定义阶段（Product Definition）
目标：明确要解决的问题与边界。

准则：
- 明确用户故事（角色/目标/收益）。
- 给出验收标准（可验证、可复现）。
- 识别是否触碰 P0 原则（RPC-only）。

退出条件：
- `02-requirements/` 与 `03-user-stories/` 已补齐条目与验收标准。

### 2.2 设计与约束检查阶段（Design & Constraints）
目标：把“怎么做”约束清楚，避免实现跑偏。

准则：
- **文档落盘优先（设计阶段硬约束）**：
  - 本阶段只允许对产品设计相关文档进行补充、对齐与落盘（需求、故事、验收、状态机、边界约束等）。
  - 本阶段禁止修改业务代码、测试代码、构建脚本与运行配置；实现改动必须进入 **2.3 实现阶段（Implementation）** 执行。
  - 若在设计评审中发现必须改代码才能澄清问题：应先记录为“待实现项/技术方案”，仍不得在本阶段直接改动代码。
- 架构上不引入中心化后端依赖。
- 明确数据生命周期：哪些数据可缓存、何时刷新、何时禁止心跳式刷新。
- 明确错误码/i18n/体验策略（例如错误去重、冷却、上限等）。

退出条件：
- `05-domain/`（术语、状态机、数据生命周期）如有变化已更新。

### 2.3 实现阶段（Implementation）
目标：按文档实现功能，保持可维护。

准则：
- 优先保证正确性与安全性，再优化性能。
- **实现阶段不新增测试代码（硬约束）**：本阶段只做功能实现与代码改动，不新增单元测试、UI 自动化测试、E2E 测试代码。
- **实现完成后的必做项（硬约束）**：必须先做代码级逻辑检查（状态流转、权限与边界条件、异常处理与恢复路径），再做关键链路回归验证。
- 实现阶段的测试要求：运行现有自动化测试进行回归检查，确认新功能不会破坏既有能力；**不得仅以“测试命令通过”作为实现完成标准**。
  - 推荐执行：`npm run test`、`npm run build`（必要时执行 `npm run test:e2e`）。
  - 若回归失败，应先修复实现代码，再继续推进。
- **实现阶段质量检查（硬约束）**：实现过程中必须持续进行以下三类质量检测，避免问题累积到验证阶段：
  - 代码质量检测：关注正确性、异常处理、边界条件、并发与资源释放风险；通过现有自动化回归命令及时发现回归。
  - 体验感检测：检查关键交互链路是否存在卡顿、阻断、提示不清、状态跳变与不可恢复操作。
  - 适配性检测：检查桌面与移动端核心链路是否可用，避免布局遮挡、不可滚动、操作入口缺失等问题。
- 仍需保证基础回归：不允许引入明显的崩溃、阻断主流程的问题。

退出条件：
- 核心功能可手动跑通关键链路。

### 2.4 验证阶段（Verification）
目标：验证实现符合预期，提前发现回归。

准则（可执行清单 + 门禁）：
0. **测试补齐主阶段（Test Completion Stage）**
   - 自动化测试（单元测试 / UI 测试 / E2E）在本阶段统一新增、补齐并达标。
   - 推荐顺序：先补单元测试（逻辑与边界）-> 再补 UI/E2E（跨组件与主流程）。
   - 目标：在进入产品验收前，使“关键路径 + 高风险场景”具备可持续回归能力。
   - **三层测试硬门禁（新增）**：本轮涉及“用户可感知功能变更”或“缺陷修复”的条目，默认必须同时补齐并通过三层测试：
     - 单元测试（逻辑、边界、状态机、错误映射）
     - UI 自动化测试（组件交互、状态展示、错误反馈、移动端可操作性）
     - E2E 测试（关键用户链路、跨模块回归）
   - **分层覆盖要求（不可互相替代）**：
     - 仅有单元测试，不可替代 UI/E2E。
     - 仅有 UI 测试，不可替代单元/E2E。
     - 仅有 E2E，不可替代单元/UI。
   - **豁免条件（严格）**：仅在“确实无法自动化且有明确客观限制”时允许豁免，且必须按“豁免模板”完整记录并给出补齐截止时间；否则不得进入产品验收阶段。
   - **落盘要求**：PR 描述或发布说明必须记录“本轮新增测试清单”（文件路径 + 覆盖场景 + 执行结果 + 对应需求/缺陷 ID）。仅执行旧测试不视为补齐完成。
1. **安全验证（Security）**
   - 前端注入与内容安全
     - 禁止/审查：`dangerouslySetInnerHTML`、`innerHTML/outerHTML` 写入、`eval/new Function/document.write`。
     - 外链安全：所有 `target="_blank"` 必须 `rel="noopener noreferrer"`。
     - URL/参数处理：审计 `window.location.search`/URL 拼接用途，确认不把敏感信息放入 URL（query/hash）。
     - CSP（可选硬化项）：若启用 CSP，至少避免 `unsafe-eval`；并记录策略与落点（`index.html` / `dist/index.html` / `dist-single/index.html`）。
   - 密钥与敏感信息
     - 私钥/助记词不得持久化：禁止写入 `localStorage/sessionStorage/indexedDB`，禁止放入 URL（query/hash），禁止写入构建产物。
     - 禁止在日志、错误消息、内置 Console 中输出私钥/助记词/原始签名材料；如确需展示，必须截断/脱敏。
     - 导入成功或失败后：输入框与临时状态必须清理，避免残留与误泄露。
   - 依赖与供应链（门禁）
     - 必跑 `npm audit --audit-level=high`；出现 `high/critical` 视为阻断项，必须修复或走豁免流程（见“豁免模板”）。
     - 新增依赖必须在 PR 描述说明用途；不得引入遥测/上报类 SDK（符合零遥测）。
   - 加密与随机数
     - 需要安全随机数时必须使用 `crypto.getRandomValues/crypto.randomUUID`，禁止 `Math.random`（仅允许用于非安全用途的 UI 标识等）。
2. **业务逻辑验证（Logic / Funds / State）**
   - 权限模型核对
     - Safe owner/threshold、发起者权限丢失、阈值变更等关键路径：状态与错误处理必须可证明（测试覆盖或明确人工验收步骤）。
   - 状态机/流转
     - onboarding -> dashboard -> send/create/add/settings 等视图流转：无卡死、无不可恢复状态。
     - SAFE/EOA 切换、切链退出 SAFE 上下文等边界行为：行为一致且可验证。
     - 登出/清理：会话状态必须完全回收（内存钱包、地址、临时输入、错误状态等）。
   - 资金/资产计算与边界条件
     - 金额/精度：明确 `bigint/number` 的边界；禁止负数；避免溢出/精度丢失。
     - token decimals、TRON 与 EVM 差异点：计算与展示一致，错误信息可理解。
   - 竞态与一致性
     - nonce/广播/轮询/超时：避免重复请求风暴、重复提交；错误提示需去重且不可“无限续命”阻断操作。
3. **工程质量与可靠性验证（Quality / Resilience）**
   - 异常处理与超时
     - RPC 请求必须可超时/可取消；错误需语义化、可去重、可恢复（能指导用户下一步）。
   - 输入校验
     - RPC URL、地址、金额、合约地址：必须校验并给出可理解提示；拒绝明显无效输入。
   - 资源释放
     - 轮询/事件监听/全局 patch（例如 XHR/fetch hook）：必须在卸载时恢复与清理，避免内存泄漏与全局污染。
   - 本地可观测性（符合零遥测）
     - 仅允许本地日志与内置 Console；不得出现远程上报、埋点、会话录制、追踪 SDK。
4. **兼容性与体验验证（Compat / i18n / UX）**
   - i18n 完整性：关键路径文案齐全，fallback 行为明确（缺失 key 不应崩溃）。
   - 多端适配：至少覆盖移动端 viewport 的核心链路。
   - 体验门槛：不允许卡死、不可滚动、遮挡、阻断操作等问题进入验收阶段。

验证证据（必须落盘到 PR 描述或发布说明）：
- 依赖门禁：`npm audit --audit-level=high`（粘贴摘要输出）
- 单元/组件测试：`npm run test`（粘贴摘要输出）
- 覆盖率门禁：`npm run test:coverage:gate`（粘贴覆盖率摘要与 gate 结果；不得低于 `.ci/coverage-baseline.json` 的 `minimum/previous`）
- 构建：`npm run build`（粘贴摘要输出）
- E2E：`npm run test:e2e`（粘贴摘要输出；若跳过 `test:e2e:real`，必须说明原因与补跑节点）
- 静态快速排查（建议在 PR 描述给出结论即可）：
  - `dangerouslySetInnerHTML/innerHTML/eval` 是否命中
  - `target="_blank"` 是否都带 `rel="noopener noreferrer"`
  - 是否存在私钥/助记词持久化或输出到日志/Console 的风险点

豁免模板（仅当确实无法在本阶段关闭时允许）：
- 豁免项：
- 豁免原因：
- 风险评估（影响面 + 可利用性）：
- 缓解措施：
- 人工验收步骤：
- 补齐计划与截止时间：

退出条件（门禁化）：
- `npm audit --audit-level=high` 通过；若不通过，必须修复或完成豁免条目（含缓解措施与到期时间）。
- `npm run test` 通过。
- `npm run test:coverage:gate` 通过（覆盖率不得低于当前基线；若需调整基线，必须在评审中说明原因并同步更新基线文件）。
- `npm run build` 通过。
- `npm run test:e2e` 通过（允许跳过 `npm run test:e2e:real`，但需写明补跑节点）。
- 安全/逻辑/质量清单无 high-risk 未决项；存在未完成项时必须逐条具备“豁免模板”的全部字段。

### 2.5 产品验收阶段（Product Acceptance）
目标：在发布前进行“终局对齐”和“补齐质量债”，确保交付可信。

准则（你制定的第一条准则，作为本阶段硬性要求）：
1. **代码与文档一致性对齐**
   - 对照 `docs/product/` 的目标、规则、需求与验收标准，审查代码实现是否一致。
   - 若不一致：必须二选一并记录
     - 更新文档以反映真实实现；或
     - 提出不一致点并修复代码使其符合文档。
2. **补齐自动化测试**
   - 本阶段不承担“测试补齐”职责，仅做验收确认。
   - 若发现单元/UI/E2E 任一层缺口，必须回退至 **2.4 验证阶段** 补齐后再进入验收。
3. **覆盖率基线确认（硬门禁）**
   - 产品验收前必须确认覆盖率门禁通过（`npm run test:coverage:gate`）。
   - 若覆盖率低于既有基线或最低阈值，不得进入验收结论“通过”。
4. **性能与体验问题修复**
   - 修复明显体验 bug（卡死、不可滚动、页面遮挡、跳转生硬等）。
   - 修复可观测的性能问题（无意义请求、重复刷新、渲染抖动、长列表卡顿等）。

退出条件（建议作为发布门槛）：
- 文档与代码已对齐（无未决不一致项）。
- 单元测试与 UI/E2E 关键链路测试通过。
- 主要性能/体验问题清零或明确降级与已知问题清单。

### 2.6 发布阶段（Release）
目标：生成版本说明与可复现交付。

准则（标准流程）：
1. **进入发布阶段即自增版本号**
   - 默认按语义化版本（SemVer）理解，并明确采用以下规则：
     - 新增功能：升级第二位版本号（`minor`）。
     - 新优化/修复：升级第三位版本号（`patch`）。
     - 破坏兼容变更：升级第一位版本号（`major`）。
   - 新增功能定义（用于版本判断）：
     - 仅指**用户可感知、可使用、可验证**的新能力（新入口/新流程/新页面/新交互结果）。
     - 不包含纯技术性改动：重构、依赖升级、脚本调整、内部代码新增、测试补充、文档修改、仅开发者可见能力等。
     - 若存在争议：以“是否改变用户完成任务的能力或路径”为判定标准；若是则按新增功能处理（`minor`），否则按优化/修复处理（`patch`）。
   - 若版本策略以路线图为准：以 `docs/product/04-roadmap/` 中的里程碑约定为优先。
   - 版本号变更需同步到相关位置（例如 `package.json`、`config/app.ts` 等），并保证 Beta 标识一致。
2. **检查自上一次发布以来的代码级变更内容**
   - 以“上一次发布记录的 commit hash”为基准，汇总本次区间内的变更（提交列表/PR 列表/关键模块变更点均可）。
   - 目标：能让研发快速回答“这次到底改了什么，风险在哪里”。
3. **检查并说明关键新增功能**
   - 从本次变更中提炼面向用户/产品的关键新增（建议 3-7 条），并在变更日志中说明价值与影响面。
4. **说明最近提交的致命 bug 修复**
   - “致命”建议包含：崩溃、资金风险、阻断主流程、数据损坏/不可恢复、严重安全问题。
   - 需写清：现象/影响、触发条件、修复方式、回归测试覆盖（或豁免记录）。
5. **发布时记录版本号、时间、commit hash**
   - 每次发布必须落盘记录（见 `docs/RELEASES.md`），作为后续排障、回滚、对外沟通的事实来源。
6. **更新面向用户/产品的变更日志**
   - 更新 `docs/CHANGELOG.md`（仅记录关键变更，不要求穷举所有提交）。

退出条件：
- `docs/CHANGELOG.md` 已更新且可用于验收。
- `docs/RELEASES.md` 已新增本次发布条目（包含版本号、时间、commit hash、关键新增、致命 bug 修复）。
- 版本说明完成，可发布。
