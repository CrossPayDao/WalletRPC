# 状态与数据生命周期

## 1. 数据分类
- 会话敏感数据：钱包实例、私钥衍生信息。
- 可持久化配置：链配置、代币配置、Safe 跟踪列表。
- 运行态数据：余额、交易状态、Safe 详情。
- 禁止持久化数据：私钥明文、助记词明文、用户行为识别数据。

## 1.1 请求边界约束（P0）
- 运行态数据的外部来源仅允许去中心化 RPC。
- 任何中心化后端业务服务不得参与业务状态计算与持久化决策。
- 不允许向分析/追踪平台发送业务行为数据。

## 1.2 密钥生命周期约束
- 私钥仅在浏览器内存中短期驻留。
- 导入成功后应清空输入缓存。
- 不得写入中心化服务、日志系统或第三方分析系统。

## 2. 刷新策略
- 默认采用 Soft Refresh（受节流控制）。
- 仅用户显式点击刷新按钮时触发 Force Refresh。
- 页面切换不应自动触发 Force Refresh。

## 3. 交易轮询策略
- 仅轮询 `submitted` 状态交易。
- 轮询需具备退避机制，避免固定高频请求。
- 达到时长/次数上限后终止轮询并标记超时失败。

## 4. 失效与清理
- 链或账户切换时，清理与当前上下文无关的临时状态。
- Safe nonce 前进时，清理已过期提案（nonce 更小的提案）。

## 5. TRON 理财流程状态机（设计）
### 5.1 流程范围
- 仅覆盖 TRON 原生资源治理理财：
  - 质押为能量/带宽
  - SR 投票
  - 领取投票奖励
  - 领奖后再质押与再投票

### 5.2 单动作状态
- `idle`：未开始
- `signing`：等待用户签名
- `submitted`：已广播，等待链上确认
- `confirmed`：链上确认成功
- `failed`：执行失败（可重试）

### 5.3 一键串行状态
- 默认顺序：`CLAIM_REWARD -> STAKE_RESOURCE -> VOTE_WITNESS`
- 状态迁移：`READY -> STEP_N_SIGNING -> STEP_N_SUBMITTED -> STEP_N_CONFIRMED -> NEXT`
- 失败迁移：任一步失败立即进入 `FAILED_AT_STEP_N`，不得继续后续步骤

### 5.4 失败恢复规则
- 仅保存非敏感输入快照（资源类型、数量、投票目标、票数、失败步骤）。
- 不保存私钥、助记词、签名原文。
- 用户可从失败步骤继续重试，或回到分步模式单独执行。

### 5.5 边界与一致性
- 链切换/账户切换时：清理进行中的 TRON 串行任务状态，防止跨上下文污染。
- 节点切换时：沿用“缓存 + 更新中/失败提示”策略，禁止将未知值误显示为 `0`。
- 不提供 APR/年化预测，仅展示链上可验证结果（当前可领奖励、已确认交易结果）。
